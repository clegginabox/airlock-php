{% extends "layout/base.twig" %}

{% block title %}Airlock: Double-Click Protection{% endblock %}

{% block styles %}
    <style>
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes lock-pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.08); opacity: 1; }
        }
        @keyframes progress-bar {
            from { width: 0%; }
            to { width: 100%; }
        }

        .status-alert {
            animation: slide-up 0.35s ease-out;
        }

        /* Lock visual */
        .lock-icon {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid oklch(var(--bc) / 0.15);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            color: oklch(var(--bc) / 0.25);
        }
        .lock-icon.locked {
            border-color: oklch(var(--wa));
            color: oklch(var(--wa));
            background: oklch(var(--wa) / 0.1);
            animation: lock-pulse 2s ease-in-out infinite;
        }
        .lock-icon.done {
            border-color: oklch(var(--su));
            color: oklch(var(--su));
            background: oklch(var(--su) / 0.1);
            animation: none;
        }
        .lock-icon.rejected {
            border-color: oklch(var(--er));
            color: oklch(var(--er));
            background: oklch(var(--er) / 0.1);
            animation: none;
        }

        /* Progress bar */
        .progress-track {
            height: 4px;
            border-radius: 2px;
            background: oklch(var(--bc) / 0.1);
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 2px;
            background: oklch(var(--wa));
            animation: progress-bar var(--duration) linear forwards;
        }

        @media (max-width: 640px) {
            .lock-icon {
                width: 72px;
                height: 72px;
            }
            .lock-icon svg {
                width: 28px;
                height: 28px;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <main class="mx-auto w-full max-w-5xl px-4 py-8 sm:py-10">
        <section class="overflow-hidden rounded-3xl border border-base-300 bg-base-200 shadow-[0_24px_80px_-40px_rgba(0,0,0,0.6)] backdrop-blur">
            <div class="relative p-6 sm:p-8 lg:p-10">
                <div class="relative space-y-8">

                    {# Header #}
                    <div class="space-y-4">
                        <div class="badge badge-primary">Redis</div>
                        <div class="badge badge-accent">Symfony Lock</div>
                        <h1 class="text-3xl font-black sm:text-4xl lg:text-5xl">
                           Double-Click Protection
                        </h1>
                        <p class="max-w-3xl text-base leading-relaxed text-base-content/70 sm:text-lg">
                            This simulates <strong class="text-base-content">global double-click prevention</strong>.
                            Once submitted, further attempts are rejected for any user until the action completes.
                        </p>
                    </div>

                    {# Stat cards #}
                    <div class="grid gap-4 sm:grid-cols-3">
                        <div class="rounded-2xl border border-base-300 bg-base-100 p-4">
                            <p class="text-xs font-semibold uppercase tracking-[0.15em] text-base-content/50">Lock Type</p>
                            <p class="mt-2 text-2xl font-black text-base-content">Global</p>
                        </div>
                        <div class="rounded-2xl border border-base-300 bg-base-100 p-4">
                            <p class="text-xs font-semibold uppercase tracking-[0.15em] text-base-content/50">Hold Duration</p>
                            <p class="mt-2 text-2xl font-black text-base-content">~10s</p>
                        </div>
                        <div class="rounded-2xl border border-base-300 bg-base-100 p-4">
                            <p class="text-xs font-semibold uppercase tracking-[0.15em] text-base-content/50">Lock State</p>
                            <p id="lock-label" class="mt-2 text-2xl font-black text-base-content/30">Unlocked</p>
                        </div>
                    </div>

                    {# Lock visual #}
                    <div class="rounded-2xl border border-base-300 bg-base-100/50 p-6">
                        <p class="mb-4 text-center text-xs font-semibold uppercase tracking-[0.2em] text-base-content/40">Lock State</p>
                        <div class="flex items-center justify-center">
                            <div id="lock-icon" class="lock-icon">
                                <svg id="lock-svg" class="h-10 w-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path id="lock-path" stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/>
                                </svg>
                            </div>
                        </div>
                        <div id="progress" class="progress-track mx-auto mt-5 hidden w-3/4 sm:w-1/2">
                            <div id="progress-fill" class="progress-fill"></div>
                        </div>
                        <p id="lock-hint" class="mt-3 text-center text-xs font-medium text-base-content/30">Ready</p>
                    </div>

                    {# Action area #}
                    <div class="rounded-2xl border border-base-300 bg-base-100 p-4 shadow-sm sm:p-5">
                        <button
                            id="go"
                            type="button"
                            class="btn btn-lg btn-primary rounded-full"
                        >
                            Run Action
                        </button>

                        <div id="status" aria-live="polite"></div>
                    </div>

                    {# Code snippet #}
                    <div class="collapse collapse-arrow rounded-2xl border border-base-300 bg-base-100/50">
                        <input type="checkbox" />
                        <div class="collapse-title text-sm font-semibold uppercase tracking-[0.12em] text-base-content/50">
                            How It Works
                        </div>
                        <div class="collapse-content">
                            <pre class="!m-0 rounded-xl"><code class="language-php">
$airlock = new OpportunisticAirlock(
    seal: new SymfonyLockSeal(
        new LockFactory(new RedisStore($redis)),
        resource: 'my-action',
        ttlInSeconds: 10,
    ),
);

$result = $airlock-&gt;enter($userId);

if ($result-&gt;isAdmitted()) {
    // Lock acquired — do the work
    doExpensiveWork();
    $airlock-&gt;release($result-&gt;getToken());
} else {
    // Lock held — reject immediately
    throw new TooManyRequestsException();
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    {# Hidden class hints for Tailwind CDN #}
    <div class="hidden">
        <div class="alert alert-info"></div>
        <div class="alert alert-success"></div>
        <div class="alert alert-warning"></div>
        <div class="alert alert-error"></div>
    </div>
{% endblock %}

{% block scripts %}
<script>
(function () {
    var LOCK_DURATION = 3; // seconds — visual estimate

    var goBtn = document.getElementById('go');
    var statusDiv = document.getElementById('status');
    var lockIcon = document.getElementById('lock-icon');
    var lockPath = document.getElementById('lock-path');
    var lockLabel = document.getElementById('lock-label');
    var lockHint = document.getElementById('lock-hint');
    var progress = document.getElementById('progress');
    var progressFill = document.getElementById('progress-fill');

    // Lock SVG paths
    var UNLOCKED_PATH = 'M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z';
    var LOCKED_PATH = 'M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z';

    // Icon SVGs
    var spinnerIcon = '<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';
    var checkIcon = '<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
    var errorIcon = '<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>';

    function alertHtml(type, icon, text) {
        return '<div class="alert alert-' + type + ' status-alert mt-5">' +
            '<span>' + icon + '</span>' +
            '<span>' + text + '</span>' +
            '</div>';
    }

    function setLocked() {
        lockIcon.className = 'lock-icon locked';
        lockPath.setAttribute('d', LOCKED_PATH);
        lockLabel.textContent = 'Locked';
        lockLabel.className = 'mt-2 text-2xl font-black text-warning';
        lockHint.textContent = 'Processing...';
        lockHint.className = 'mt-3 text-center text-xs font-medium text-warning/60';
        progress.classList.remove('hidden');
        // Reset animation
        progressFill.style.animation = 'none';
        progressFill.offsetHeight;
        progressFill.style.setProperty('--duration', LOCK_DURATION + 's');
        progressFill.style.animation = '';
    }

    function setUnlocked() {
        lockIcon.className = 'lock-icon done';
        lockPath.setAttribute('d', UNLOCKED_PATH);
        lockLabel.textContent = 'Unlocked';
        lockLabel.className = 'mt-2 text-2xl font-black text-success';
        lockHint.textContent = 'Complete';
        lockHint.className = 'mt-3 text-center text-xs font-medium text-success/60';
        progress.classList.add('hidden');
    }

    function setRejected() {
        lockIcon.className = 'lock-icon rejected';
        lockPath.setAttribute('d', LOCKED_PATH);
        lockLabel.textContent = 'Held';
        lockLabel.className = 'mt-2 text-2xl font-black text-error';
        lockHint.textContent = 'Locked by another request';
        lockHint.className = 'mt-3 text-center text-xs font-medium text-error/60';
        progress.classList.add('hidden');
    }

    function setIdle() {
        lockIcon.className = 'lock-icon';
        lockPath.setAttribute('d', UNLOCKED_PATH);
        lockLabel.textContent = 'Unlocked';
        lockLabel.className = 'mt-2 text-2xl font-black text-base-content/30';
        lockHint.textContent = 'Ready';
        lockHint.className = 'mt-3 text-center text-xs font-medium text-base-content/30';
        progress.classList.add('hidden');
    }

    // Check initial lock state
    fetch('/global-lock/status')
        .then(function (res) { return res.json(); })
        .then(function (data) {
            if (data.locked) {
                lockIcon.className = 'lock-icon locked';
                lockPath.setAttribute('d', LOCKED_PATH);
                lockLabel.textContent = 'Locked';
                lockLabel.className = 'mt-2 text-2xl font-black text-warning';
                lockHint.textContent = 'Held by another request';
                lockHint.className = 'mt-3 text-center text-xs font-medium text-warning/60';
            }
        })
        .catch(function () {});

    goBtn.addEventListener('click', async function () {
        statusDiv.innerHTML = alertHtml('info', spinnerIcon, 'Processing...');
        statusDiv.className = '';
        setLocked();

        try {
            var res = await fetch('/global-lock/start', { method: 'POST' });
            var data = await res.json();

            if (!res.ok || !data.ok) {
                statusDiv.innerHTML = alertHtml('error', errorIcon, data.error || 'Already processing');
                statusDiv.className = 'error';
                setRejected();

                // Auto-reset after 3s
                setTimeout(function () {
                    setIdle();
                    statusDiv.innerHTML = '';
                    statusDiv.className = '';
                }, 3000);
            } else {
                statusDiv.innerHTML = alertHtml('success', checkIcon, 'Done!');
                statusDiv.className = 'ok';
                setUnlocked();

                // Auto-reset after 3s
                setTimeout(function () {
                    setIdle();
                    statusDiv.innerHTML = '';
                    statusDiv.className = '';
                }, 3000);
            }
        } catch (err) {
            statusDiv.innerHTML = alertHtml('error', errorIcon, 'Network error: ' + err.message);
            statusDiv.className = 'error';
            setRejected();
        }
    });
})();
</script>
{% endblock %}
