{% extends "layout/base.twig" %}

{% block title %}Airlock: Double-Click Protection{% endblock %}

{% block body %}
    <main class="mx-auto w-full max-w-5xl px-4 py-8 sm:py-10">
        <section class="overflow-hidden rounded-3xl border border-base-300 bg-base-200 shadow-[0_24px_80px_-40px_rgba(0,0,0,0.6)] backdrop-blur">
            <div class="relative p-6 sm:p-8 lg:p-10">
                <div class="relative space-y-8">

                    {# Header #}
                    <div class="space-y-4">
                        <div class="badge badge-primary">Redis</div>
                        <div class="badge badge-accent">Symfony Lock</div>
                        <h1 class="text-3xl font-black sm:text-4xl lg:text-5xl">
                           Double-Click Protection
                        </h1>
                        <p class="max-w-3xl text-base leading-relaxed text-base-content/70 sm:text-lg">
                            This simulates <strong class="text-base-content">global double-click prevention</strong>.
                            Once submitted, further attempts are rejected for any user until the action completes.
                        </p>
                    </div>

                    {# Stat cards #}
                    <div class="grid gap-4 sm:grid-cols-3">
                        <div class="rounded-2xl border border-base-300 bg-base-100 p-4">
                            <p class="text-xs font-semibold uppercase tracking-[0.15em] text-base-content/50">Lock Type</p>
                            <p class="mt-2 text-2xl font-black text-base-content">Global</p>
                        </div>
                        <div class="rounded-2xl border border-base-300 bg-base-100 p-4">
                            <p class="text-xs font-semibold uppercase tracking-[0.15em] text-base-content/50">Hold Duration</p>
                            <p class="mt-2 text-2xl font-black text-base-content">~10s</p>
                        </div>
                        <div class="rounded-2xl border border-base-300 bg-base-100 p-4">
                            <p class="text-xs font-semibold uppercase tracking-[0.15em] text-base-content/50">Lock State</p>
                            <p id="lock-label" class="mt-2 text-2xl font-black text-base-content/30">Unlocked</p>
                        </div>
                    </div>

                    {# Lock visual #}
                    <div class="rounded-2xl border border-base-300 bg-base-100/50 p-6">
                        <p class="mb-4 text-center text-xs font-semibold uppercase tracking-[0.2em] text-base-content/40">Lock State</p>
                        <div class="flex items-center justify-center">
                            <div id="lock-icon" class="lock-icon">
                                <svg id="lock-svg" class="h-10 w-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path id="lock-path" stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/>
                                </svg>
                            </div>
                        </div>
                        <div id="progress" class="progress-track mx-auto mt-5 hidden w-3/4 sm:w-1/2">
                            <div id="progress-fill" class="progress-fill"></div>
                        </div>
                        <p id="lock-hint" class="mt-3 text-center text-xs font-medium text-base-content/30">Ready</p>
                    </div>

                    {# Action area #}
                    <div class="rounded-2xl border border-base-300 bg-base-100 p-4 shadow-sm sm:p-5">
                        <button
                            id="go"
                            type="button"
                            class="btn btn-lg btn-primary rounded-full"
                        >
                            Run Action
                        </button>

                        <div id="status" aria-live="polite"></div>
                    </div>

                    {# Code snippet #}
                    <div class="collapse collapse-arrow rounded-2xl border border-base-300 bg-base-100/50">
                        <input type="checkbox" />
                        <div class="collapse-title text-sm font-semibold uppercase tracking-[0.12em] text-base-content/50">
                            How It Works
                        </div>
                        <div class="collapse-content">
                            <pre class="!m-0 rounded-xl"><code class="language-php">
$airlock = new OpportunisticAirlock(
    seal: new SymfonyLockSeal(
        new LockFactory(new RedisStore($redis)),
        resource: 'my-action',
        ttlInSeconds: 10,
    ),
);

$result = $airlock-&gt;enter($userId);

if ($result-&gt;isAdmitted()) {
    // Lock acquired — do the work
    doExpensiveWork();
    $airlock-&gt;release($result-&gt;getToken());
} else {
    // Lock held — reject immediately
    throw new TooManyRequestsException();
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
{% endblock %}

{% block scripts %}
    {{ vite('resources/js/pages/global-lock.js') }}
{% endblock %}
